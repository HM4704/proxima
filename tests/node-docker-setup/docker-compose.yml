services:
  Proxima-Node:
    container_name: Proxima-Node
    build:
      context: ../../..
      dockerfile: proxima/tests/node-docker-setup/dockerfile
    image: proxima-node:latest    
    ports:
      - "8000:8000"
      - "4000:4000"
      #- "14000:14000/tcp"   # Prometheus
    environment:
      - DEBUG=true
    volumes:
      - ./data/proximadb:/app/proximadb
      - ./data/proximadb.txstore:/app/proximadb.txstore
      - ./data/config:/app/config
      - ./data/snapshot:/app/snapshot
    working_dir: /app     
    command: ["./start.sh"]


##################################################################
#  Monitoring                                                    #
##################################################################

  prometheus:
    container_name: prometheus
    image: prom/prometheus:latest
    restart: unless-stopped
    user: "65532"
    volumes:
      - ./data/prometheus/:/prometheus
      - ./assets/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - /etc/localtime:/etc/localtime:ro
    #profiles:
    #  - monitoring

  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    restart: unless-stopped
    user: "65532"
    #labels:
      #- "traefik.enable=true"
      #- "traefik.http.routers.grafana.rule=Host(`${NODE_HOST:-localhost}`) && (Path(`/grafana`) || PathPrefix(`/grafana/`))"
      #- "traefik.http.routers.grafana.entrypoints=web"
      #- "traefik.http.services.grafana.loadbalancer.server.port=3000"
    ports:
      - "3000:3000"
    environment:
      - GF_SERVER_ROOT_URL=/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_SERVER_DOMAIN=${NODE_HOST:-localhost}
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/Proxima_dashboard.json
    volumes:
      #- ./data/grafana:/var/lib/grafana
      - ./assets/grafana/:/etc/grafana/provisioning/
    #profiles:
    #  - monitoring
